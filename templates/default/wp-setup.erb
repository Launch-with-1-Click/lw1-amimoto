#!/bin/sh
if [ $# -ne 0 ]; then
  SITENAME=$1
else
  SITENAME="<%= @default_server_name %>"
fi

if [ -f /var/www/vhosts/$SITENAME/wp-config.php ]; then
  exit 0
fi

echo "start..."
echo ""

if [ ! -f /usr/bin/chef-solo ]; then
  ln -s /opt/chef/bin/chef-solo /usr/bin/chef-solo
fi

if [ -e /tmp/amimoto ]; then
  /bin/rm -Rf /tmp/amimoto
fi

cd /tmp/
/usr/bin/git clone git://github.com/Launch-with-1-Click/lw1-amimoto.git amimoto
cd /tmp/amimoto
/usr/bin/git checkout 2016.01.wp-setup
/usr/bin/chef-solo -o amimoto::wpcli -c /opt/local/solo.rb -l error
if [ -f /usr/local/bin/wp-setup-json ]; then
  if [ ! -f /opt/local/${SITENAME}.json ]; then
    /usr/local/bin/wp-setup-json ${SITENAME} | /usr/bin/jq '.' > /opt/local/${SITENAME}.json
  fi
  /usr/bin/chef-solo -o amimoto::wordpress -c /opt/local/solo.rb -j /opt/local/${SITENAME}.json -l error
fi
/bin/rm -Rf /tmp/amimoto
/bin/rm -Rf /tmp/.cache/wpplugins

echo ""
echo "...done"
